---
title: servletåŸºç¡€
date: 2018-02-28 20:47:14
tags:
---


Servletæ²¡æœ‰mainæ–¹æ³•ï¼Œå®ƒä»¬å—æ§äºå®¹å™¨ï¼›
æœåŠ¡å™¨ä¸æ˜¯å°†è¯·æ±‚äº¤ç»™servletæœ¬èº«ï¼Œè€Œæ˜¯äº¤ç»™éƒ¨ç½²è¯¥servletçš„å®¹å™¨ï¼Œç”±å®¹å™¨å‘servletæä¾›HTTPè¯·æ±‚å’Œå“åº”ï¼Œç”±å®¹å™¨è°ƒç”¨servletçš„æ–¹æ³•ï¼Œå¦‚doPost()ä½•doGet()ã€‚

# servletäº¤äº’æµç¨‹

- ç”¨æˆ·ç‚¹å‡»ä¸€ä¸ªé“¾æ¥ï¼Œè¯·æ±‚æŒ‡å‘ä¸€ä¸ªservletï¼ˆ HttpServlet ï¼‰ï¼›
- å®¹å™¨åˆ›å»º HttpServletRequestå’ŒHttpServletResponse;
- å®¹å™¨æ ¹æ®è¯·æ±‚ä¸­çš„urlï¼Œæ‰¾åˆ°æ­£ç¡®çš„servletï¼Œä¸ºè¿™ä¸ªè¯·æ±‚åˆ›å»ºæˆ–åˆ†é…ä¸€ä¸ªçº¿ç¨‹ã€‚å¹¶å°†HttpServletRequestå’ŒHttpServletResponseå¯¹è±¡ä¼ é€’ç»™è¿™ä¸ªçº¿ç¨‹ï¼›
- å®¹æ˜“è°ƒç”¨servletçš„service()æ–¹æ³•ï¼Œæ ¹æ®è¯·æ±‚çš„ä¸åŒç±»å‹ã€‚service()æ–¹æ³•è°ƒç”¨doGet()ã€doPost()æˆ–å…¶ä»–æ–¹æ³•ï¼›
- doGet()æ–¹æ³•ç”ŸæˆåŠ¨æ€é¡µé¢ï¼Œå¹¶æŠŠè¿™ä¸ªé¡µé¢â€œå¡«å…¥â€å“åº”å¯¹è±¡ï¼ˆå®¹å™¨è¿˜æœ‰å“åº”å¯¹è±¡çš„ä¸€ä¸ªå¼•ç”¨ï¼‰ã€‚
- çº¿ç¨‹ç»“æŸï¼Œå®¹å™¨æŠŠå“åº”å¯¹è±¡è½¬æ¢ä¸ºä¸€ä¸ªHTTPå“åº”ï¼Œè¿”å›å®¢æˆ·ã€‚åˆ é™¤è¯·æ±‚å’Œå“åº”å¯¹è±¡

# web.xml
å®¹å™¨è¯»å–web.xmlï¼ˆéƒ¨ç½²æè¿°æ–‡ä»¶DDï¼Œä½äºWEB-INFæ–‡ä»¶å¤¹ä¸­ï¼‰ä¸­çš„servlet

```
web.xml
<web-app...>
  <servlet>
    <servlet-name>demo class name</servlet-name>
    <servlet-class>demoClass</servlet-class>
  </servlet>

  <servlet-mapping>
    <servlet-name>demo class name</servlet-name>
    <url-pattern>/matchUrl</url-pattern>
  </servlet-mapping>
</web-app>
```

# servletçº¿ç¨‹å®‰å…¨

**å®¹å™¨è¿è¡Œå¤šä¸ªçº¿ç¨‹ï¼Œå¤„ç†å¯¹ä¸€ä¸ªservletçš„å¤šä¸ªè¯·æ±‚**
å¯¹åº”æ¯ä¸ªè¯·æ±‚ä¼šç”Ÿæˆä¸€å¯¹è¯·æ±‚å’Œå“åº”å¯¹è±¡

# servletç”Ÿå‘½å‘¨æœŸ
- æ„é€ å‡½æ•°init()
- è¿è¡Œä¸­service()
- é”€æ¯destory()

## servlet åˆå§‹åŒ–å‚æ•° 

<font color=#0099ff>**servletåˆå§‹åŒ–å‚æ•°åªèƒ½è¯»ä¸€æ¬¡**</font>
å®¹å™¨å»ºç«‹servletæ—¶ï¼Œä¼šè¯»DDï¼ˆweb.xmlï¼‰ï¼Œå¹¶ä¸ºServletConfigåˆ›å»ºå/å€¼å¯¹ã€‚æ­¤åå®¹å™¨ä¸ä¼šå†è¯»åˆå§‹åŒ–å‚æ•°ï¼
ä¸€æ—¦å‚æ•°ç½®äºServletConfigä¸­ï¼Œå°±ä¸ä¼šå†è¯»äº†ï¼Œé™¤éé‡æ–°éƒ¨ç½²Servletã€‚

> åˆå§‹åŒ–å‚æ•°ä½äº`ServletConfig`ä¸­ -> æ„é€ `javax.servlet.HttpServlet`é€šè¿‡è°ƒç”¨`init(servletConfig)`æ–¹æ³•ï¼Œå…¶ä¸­å‚æ•°ä¸º`javax.servlet.ServletConfig`

DDæ–‡ä»¶ï¼ˆweb.xmlï¼‰ä¸­ï¼Œ`<web-app>` - `<servlet>` - `<init-param>`ï¼Œé…ç½®åˆå§‹åŒ–å‚æ•° ï¼š

```
<servlet>
  <servlet-name>Â·Â·Â·<servlet-name>
  <servlet-class>Â·Â·Â·</servlet-name>

  <init-param>
    <param-name>propertyName</param-name>
    <param-value>propertyValue</param-value>
  </init-param>
</servlet>
```

servletä»£ç ä¸­è·å–æ–¹å¼ `extends HttpServlet`
```
getServletConfig().getInitParameter("propertyName");
```

## servlet åˆå§‹åŒ–é¡ºåº

> å¦‚æœå¸Œæœ›åœ¨éƒ¨ç½²ï¼ˆæˆ–æœåŠ¡å™¨é‡å¯æ—¶ï¼‰åŠ è½½servletï¼Œè€Œä¸æ˜¯ç­‰åˆ°ç¬¬ä¸€ä¸ªè¯·æ±‚åˆ°æ¥æ—¶æ‰åŠ è½½ï¼Œå¯ä»¥åœ¨DDä¸­ä½¿ç”¨`<load-on-startup>`å…ƒç´ ã€‚
	é€šè¿‡å°†`<load-on-startup>`çš„å€¼è®¾ç½®ä¸ºéè´Ÿï¼ˆ â‰¥ 0 ï¼‰

- servleté»˜è®¤åŠ è½½é¡ºåºä¸ºDDæ–‡ä»¶ï¼ˆweb.xmlï¼‰ä¸­çš„é…ç½®ç†Ÿæ‚‰æ€’
- æ•°å€¼è¶Šå¤§ï¼ŒåŠ è½½æ—¶åºè¶Šä½ï¼ˆå¦‚æœä¸€ä¸ªservletçš„åŠ è½½é¡ºåºè®¾ç½®ä¸º4ï¼Œè¡¨ç¤ºè¿™ä¸ªservletåº”å½“åœ¨å€¼å°äº4çš„å…¶ä»–servletåŠ è½½åå†åŠ è½½ï¼‰


```
<servlet>
  ...
  ...
  <load-on-startup>1</load-on-startup>
</servlet>
```

## servlet ä¸Šä¸‹æ–‡åˆå§‹åŒ–å‚æ•°

> å¦‚æœå¿…é¡»åŒæ­¥ä¿®æ”¹ServletContextä¸­å±æ€§ï¼Œå¯ä»¥é€šè¿‡å¯¹ServletContextåŠ é”ï¼š`synchronized(getServletContext()) { ... }`

context-paramæ˜¯é’ˆå¯¹æ•´ä¸ªåº”ç”¨çš„ï¼Œæ‰€ä»¥ä¸å‰å¥—åœ¨`servlet`ä¸­

DDæ–‡ä»¶ï¼ˆweb.xmlï¼‰ä¸­ï¼Œ`<web-app>` - `<context-param>`ï¼Œé…ç½®åˆå§‹åŒ–å‚æ•° ï¼š
```
<context-param>
  <param-name>contextProperty</param-name>
  <param-value>contextPropertyValue</param-value>
</context-param>
```

servletä»£ç ä¸­çš„è·å–æ–¹å¼ `extends HttpServlet`
```
getServletContext().getInitParameter("contextProperty");
```

# ServletConfig vs ServletCotext
1. `ServletConfig`ï¼šservletçš„ä¸€äº›é…ç½®å±æ€§ï¼Œå¦‚servletçš„åˆå§‹åŒ–å‚æ•°ï¼›ç”¨äºè®¿é—®`ServletContext`ï¼›`HttpServlet`çš„å­ç±»å¯ä»¥é€šè¿‡`getServletConfig`è·å–`ServletConfig`
2. `ServletContext`ï¼šæ›´é€‚åˆå«åšAppContextï¼Œæ¯ä¸ªwebåº”ç”¨åªæœ‰ä¸€ä¸ª`ServletContext`ï¼Œç”¨äºè®¿é—®webåº”ç”¨å‚æ•°

æ¯ä¸ªServletæœ‰ä¸€ä¸ªå¯¹åº”çš„`ServletConfig`ï¼›
æ¯ä¸ªåº”ç”¨æœ‰ä¸€ä¸ª`ServletContext`

## ç›‘å¬`ServletContext`çš„åˆ›å»ºå’Œé”€æ¯ - `ServletContextListener`ï¼ˆ**ä¸Šä¸‹æ–‡ä½œç”¨åŸŸä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„**ï¼‰

`ServletContextListener`.`contextInitialized(ServletContextEvent)`
`ServletContextListener`.`contextDestroyed(ServletContextEvent)`

å®ç°`ServletContextListener`æ¥å£
```
public class MyServletContextListener implements ServletContextListener { ... }
```

xmlé…ç½®æ–¹å¼
```
<listener>
  <listener-class>com.example.MyServletContextListener</listener-class>
</listener>
```

### servlet 8ä¸ªç›‘å¬å™¨

åœºæ™¯                            | listener | äº‹ä»¶ç±»å‹
------------------------------------- | ----------------------------------|----
å¸Œæœ›çŸ¥é“ä¸€ä¸ªWebåº”ç”¨ä¸Šä¸‹æ–‡ä¸­æ˜¯å¦å¢åŠ ã€åˆ é™¤æˆ–æ›¿æ¢ä¸€ä¸ªå±æ€§|ServletContextAttributeListener|ServletContextAttributeEvent
äº†è§£æœ‰å¤šå°‘å¹¶å‘ç”¨æˆ·|HttpSessionListener                   | HttpSessionEvent                  
äº†è§£è¯·æ±‚åˆ°è¾¾ï¼Œæ¯”å¦‚éœ€è¦å»ºç«‹è®°å½•æ—¥å¿—|ServletRequestListener                | ServletRequestEvent               
å¸Œæœ›äº†è§£å¢åŠ ã€åˆ é™¤æˆ–æ›¿æ¢ä¸€ä¸ªè¯·æ±‚å±æ€§|ServletRequestAttributeListener | ServletRequestAttributeEvent
æœ‰ä¸€ä¸ªå±æ€§ç±»ï¼ˆè¿™ä¸ªç±»è¡¨ç¤ºçš„å¯¹è±¡å°†æ”¾åœ¨ä¸€ä¸ªå±æ€§ä¸­ï¼‰ï¼Œå¸Œæœ›è¿™ä¸ªç±»å‹çš„å¯¹è±¡åœ¨ç»‘å®šåˆ°ä¸€ä¸ªä¼šè¯æˆ–ä»ä¼šè¯åˆ é™¤æ—¶å¾—åˆ°é€šçŸ¥|HttpSessionBindingListener     |HttpSessionBindingEvent
å¸Œæœ›äº†è§£å¢åŠ ã€åˆ é™¤æˆ–æ›¿æ¢ä¸€ä¸ªä¼šè¯å±æ€§|HttpSessionAttributeListener    | HttpSessionBindingEvent           
äº†è§£æ˜¯å¦åˆ›å»ºæˆ–æ’¤é”€ä¸€ä¸ªä¸Šä¸‹æ–‡|ServletContextListener                | ServletContextEvent               
æœ‰ä¸€ä¸ªå±æ€§ç±»ï¼Œå¹¶å¸Œæœ›è¿™ä¸ªç±»å‹çš„å¯¹è±¡åœ¨å…¶ç»‘å®šçš„ä¼šè¯è¿ç§»åˆ°å¦ä¸€ä¸ªJVMæ—¶ï¼Œå¾—åˆ°é€šçŸ¥|HttpSessionActivationListener|HttpSessionEvent **ä¸æ˜¯HttpSessionActivationEvent**

### `HttpSessionAttributeListener` vs `HttpSessionBindingListener`
- `HttpSessionAttributeListener`ï¼šå¸Œæœ›ç»˜ç”»ä¸­åœ¨å¢åŠ ã€åˆ é™¤æˆ–æ›¿æ¢æŸç§ç±»å‹çš„å±æ€§æ—¶èƒ½å¤ŸçŸ¥æ™“ï¼›
- `HttpSessionBindingListener`ï¼šæœ‰äº†HttpSessionBindingListenerï¼Œå±æ€§æœ¬èº«æ‰èƒ½å¤Ÿåœ¨å¢åŠ åˆ°ä¸€ä¸ªä¼šè¯æˆ–è€…ä»ä¼šè¯åˆ é™¤æ—¶å¾—åˆ°é€šçŸ¥ï¼›
	`HttpSessionBindingListener`.`valueBound(HttpSessionBindingEvent)`
	`HttpSessionBindingListener`.`valueUnbound(HttpSessionBindingEvent)`

## ä¸€äº›æ¦‚å¿µ
- ä¸Šä¸‹æ–‡ï¼šServletContext
- è¯·æ±‚ï¼šServletRequest
- ä¼šè¯ï¼šHttpSession

## RequestDispatcher

è®©ç»„ä»¶çš„å…¶ä»–éƒ¨åˆ†æ¥ç®¡è¿™ä¸ªè¯·æ±‚ï¼›é€šè¿‡`ServletContext`è·å–`RequestDispatcher`

`RequestDispatcher`.`forward()`
`RequestDispatcher`.`include()`

# servleté‡å®šå‘
sendRedirect

# æ‹¦æˆªå™¨ filter

> `javax.servlet.Filter`
å…è®¸æ‹¦æˆªè¯·æ±‚ï¼Œå¹¶ä¸”servletå¯¹æ­¤ä¸€æ— æ‰€çŸ¥ï¼›å‘ç”Ÿåœ¨è°ƒç”¨servletçš„serviceæ–¹æ³•ä¹‹å‰ï¼›

- å®¹å™¨çŸ¥é“è¿‡æ»¤å™¨APIï¼š`javax.servlet.Filter`
- å®¹å™¨ç®¡ç†è¿‡æ»¤å™¨çš„ç”Ÿå‘½å‘¨æœŸ
- éƒ½åœ¨DDä¸­å£°æ˜

## æ‹¦æˆªå™¨Filterç”Ÿå‘½å‘¨æœŸ

æ‹¥æœ‰ç±»ä¼¼äºservletçš„init()å’Œdestory()æ–¹æ³•ï¼Œinitçš„ä¼ å…¥å‚æ•°ä¸ºFilterConfigï¼Œå¯¹åº”äºservletçš„doGet()å’ŒdoPost()ï¼Œè¿‡æ»¤å™¨æœ‰doFilter()æ–¹æ³• 

- `init(FilterConfig)`ï¼šåˆå§‹åŒ–Filter
- `doFilter()`å®Œæˆæ‰€æœ‰å·¥ä½œï¼Œå‚æ•°ä¸ºï¼š
	1) `ServletRequest`ï¼Œè€Œé`HttpServletRequest`
	2) `ServletResponse`ï¼Œè€Œé`HttpServletResponse`
	3) ä¸€ä¸ª`FilterChain`
- `destory()` å®ŒæˆFilterçš„é”€æ¯

## Filterå£°æ˜æ–¹å¼

### å£°æ˜Filter

```
<filter>
  <filter-name>filterName</filter-name>
  <filter-class>filterClass</filter-class>
  <init-param>
    <param-name>filterInitParamName</param-name>
    <param-value>filterInitParamValue</param-value>
  </init-param>
</filter>
```

### filter-mapping

`<url-pattern>`æˆ–`<servlet-name>`å…ƒç´ å¿…é¡»äºŒé€‰ä¸€

#### å£°æ˜å¯¹åº”URLæ¨¡å¼çš„è¿‡æ»¤å™¨æ˜ å°„

```
<filter-mapping>
  <filter-name>filterName</filter-name>
  <url-pattern>*.filterUrlPattern</url-pattern>
</filter-mapping>
```

#### å£°æ˜å¯¹åº”Servletåçš„è¿‡æ»¤å™¨æ˜ å°„

```
<filter-mapping>
  <filter-name>filterName</filter-name>
  <servlet-name>servletName</servlet-name>
</filter-mapping>
```

# Servlet åŒ…è£…å™¨ - `*Wrapper`

**ä¸€ä¸ªä½¿ç”¨åœºæ™¯**
éœ€è¦å¯¹æ‰€æœ‰è¿”å›å€¼responseè¿›è¡Œå‹ç¼©ï¼›

å½“æˆ‘ä»¬æœ‰æ“ä½œrequestæˆ–responseçš„éœ€æ±‚æ—¶ï¼Œå¯ä»¥å¢åŠ ä¸€ä¸ªFilterï¼Œå¹¶åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå°†requestæˆ–responseæ›¿æ¢ä¸ºåŒ…è£…ç±»ï¼ˆWrapperï¼‰ï¼Œå®ç°åŠŸèƒ½çš„ä¿®æ”¹

> **[å®¹å™¨]** -> doFilter(req, resp) -> **[Filter.filter()]** -> chain.doFilter(req, respWrapper) -> **[Servlet]**

åŒ…è£…ç±»çš„ä¼˜åŠ¿
è‡ªå®šä¹‰ServletRequest, ServletResponseéœ€è¦å®ç°è¿‡å¤šç»†èŠ‚ï¼Œè€Œé¢„å®šä¹‰çš„Wrapperåˆšå¥½è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬åªéœ€è¦è¦†å†™æ‰€éœ€çš„æ–¹æ³•ï¼›

servleté¢„æä¾›çš„wrapper
- `ServletRequestWrapper`
- `HttpServletRequestWrapper`
- `ServletResponseWrapper`
- `HttpServletResponseWrapper`

## å‹ç¼©è¿”å›å€¼çš„ğŸŒ°

```
class CompressionResponseWrapper extends HttpServletResponseWrapper {
  // è¦†ç›–æƒ³å®šåˆ¶çš„æ–¹æ³•ï¼Œå¯¹è¿”å›æµè¿›è¡Œå‹ç¼©
  public ServletOutputStream getOutputStream() throws ... {
  	...
  	return new GzipSos(resp.getOutputStream());
  }
}

class MyCompressionFilter implements Filter {

  public void init(FilterConfig cfg) { ... }

  public void doFilter( request, response, chain) {

    // è¿™é‡Œç”¨å®šä¹‰çš„åŒ…è£…å™¨ç±»â€˜åŒ…è£…â€™å“åº”response
    CompressionResponseWrapper wrappedResp
      = new CompressionResponseWrapper(response);

    chain.doFilter(request, wrappedResp);

    // å®Œæˆå‹ç¼©é€»è¾‘
  }

  public void destroy() { ... }
}
```